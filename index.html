<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Davis Knaves - Balanced +2</title>
    <style>
        :root { --gold: #ffd700; --bg: #050505; --card-w: 48px; --card-h: 70px; --lead-green: #00ff00; }
        body { background: var(--bg); color: white; font-family: -apple-system, sans-serif; margin: 0; overflow: hidden; position: fixed; width: 100%; height: 100dvh; }
        #game-layout { display: flex; flex-direction: column; height: 100dvh; background: radial-gradient(circle, #1b4d21 0%, #0a200b 100%); padding-bottom: env(safe-area-inset-bottom); box-sizing: border-box; justify-content: space-between; }
        #watermark { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); font-size: 2.2rem; color: rgba(255,215,0,0.08); font-weight: 900; pointer-events: none; z-index: 1; letter-spacing: 4px; }
        #hud { position: relative; padding: 10px; display: flex; justify-content: space-between; z-index: 100; align-items: flex-start; }
        #score-panel { background: rgba(0,0,0,0.85); padding: 5px; border-radius: 4px; border: 1px solid #444; width: 70%; }
        #score-table { font-size: 0.7rem; border-collapse: collapse; text-align: center; width: 100%; }
        #score-table th { color: var(--gold); border-bottom: 1px solid #555; }
        .j-mini { font-size: 0.65rem; margin-left: 2px; color: var(--gold); font-weight: bold; background: rgba(255,215,0,0.2); padding: 0 2px; border-radius: 2px; }
        #trump-box { background: white; color: black; padding: 8px; border-radius: 6px; border: 3px solid var(--gold); text-align: center; font-weight: bold; font-size: 1rem; min-width: 70px; }
        #arena { flex: 1; display: grid; grid-template-areas: ". north ." "west table east" ". south ."; grid-template-columns: 1fr 1.2fr 1fr; grid-template-rows: 1fr 1.4fr 1fr; position: relative; }
        .plr-tag { font-size: 0.75rem; background: #222; padding: 4px 10px; border-radius: 6px; }
        .active-tag { background: #00ff00 !important; color: #000 !important; font-weight: bold; box-shadow: 0 0 12px #00ff00; }
        .slot { width: var(--card-w); height: var(--card-h); border: 1px dashed rgba(255,255,255,0.15); border-radius: 6px; margin: auto; display: flex; align-items: center; justify-content: center; }
        .card { width: var(--card-w); height: var(--card-h); background: white; color: black; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; border: 1px solid #999; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        .card.red { color: #d32f2f; }
        .card.legal { border: 2.5px solid #00ff00; transform: translateY(-4px); }
        .card.selected { border: 3px solid var(--gold); transform: translateY(-15px); background: #fffbe6; }
        .lead-highlight { border: 3px solid var(--lead-green) !important; box-shadow: 0 0 15px var(--lead-green); }
        #player-zone { display: flex; flex-direction: column; align-items: center; width: 100%; padding-bottom: 10px; }
        #player-hand { display: flex; gap: 3px; justify-content: center; width: 100%; padding: 0 10px; box-sizing: border-box; }
        .btn { padding: 10px 20px; background: var(--gold); border: none; border-radius: 6px; font-weight: bold; font-size: 0.9rem; cursor: pointer; color: black; box-shadow: 0 4px 0 #b8860b; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 5000; }
        .modal { background: white; color: black; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; }
    </style>
</head>
<body>
<div id="game-layout">
    <div id="watermark">DAVIS KNAVES</div>
    <div id="hud">
        <div id="score-panel">
            <table id="score-table">
                <thead><tr><th>PLAYER</th><th>RND</th><th>TOT</th></tr></thead>
                <tbody id="score-body"></tbody>
            </table>
        </div>
        <div id="trump-box">TRUMP<br><span id="trump-suit">♣</span></div>
    </div>
    <div style="height:30px; text-align:center; font-weight:bold; color:var(--gold);" id="status-bar"></div>
    <div id="arena">
        <div style="grid-area: north; text-align: center;"><div id="tag-1" class="plr-tag">NORTH</div><div id="slot-1" class="slot"></div></div>
        <div style="grid-area: west; text-align: center;"><div id="tag-3" class="plr-tag">WEST</div><div id="slot-3" class="slot"></div></div>
        <div style="grid-area: south; text-align: center;"><div id="tag-0" class="plr-tag">YOU</div><div id="slot-0" class="slot"></div></div>
        <div style="grid-area: east; text-align: center;"><div id="tag-2" class="plr-tag">EAST</div><div id="slot-2" class="slot"></div></div>
    </div>
    <div id="player-zone">
        <div id="btn-container" style="margin-bottom:10px; height:40px; display:flex; align-items:center;"></div>
        <div id="player-hand"></div>
    </div>
</div>
<div id="overlay"><div class="modal" id="modal-content">
    <h2 style="margin:0; color:#1b4d21;">DAVIS KNAVES</h2>
    <p style="font-size:0.9rem;">Trick 1 & 13: -1 pt<br>Each Jack: -1 pt<br>Clean Middle Trick: +2 pts</p>
    <button class="btn" style="width:100%" onclick="startGame()">START GAME</button>
</div></div>

<script>
const SUITS = ['♣','♦','♠','♥'], VALS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'], ROTATION = ['♣','♦','♥','♠','NT'], CW_ORDER = [0, 3, 1, 2];
let state = { players: [], handIdx: 0, trump: '♣', turn: null, trick: [], tricksPlayed: 0, selected: [], phase: 'IDLE' };

function startGame() { init(); document.getElementById('overlay').style.display = 'none'; }
function init() { state.players = Array.from({length: 4}, (_, i) => ({ id: i, name: i === 0 ? "YOU" : ["NORTH", "EAST", "WEST"][i-1], hand: [], hScore: 0, total: 0, jacks: [] })); startRound(); }

function startRound() {
    state.phase = 'PASSING'; state.trump = ROTATION[state.handIdx % 5]; state.tricksPlayed = 0; state.trick = []; state.selected = [];
    state.players.forEach(p => { p.jacks = []; p.hScore = 0; });
    let deck = []; SUITS.forEach(s => VALS.forEach(v => deck.push({s, v, r: VALS.indexOf(v)}))); deck.sort(() => Math.random() - 0.5);
    state.players.forEach(p => { p.hand = deck.splice(0, 13); sortHand(p); });
    const ts = document.getElementById('trump-suit'); ts.innerText = state.trump;
    ts.style.color = (state.trump==='♥'||state.trump==='♦') ? 'red' : 'black';
    updateUI();
}

function sortHand(p) { p.hand.sort((a,b) => a.s !== b.s ? SUITS.indexOf(a.s)-SUITS.indexOf(b.s) : a.r-b.r); }

function updateUI() {
    const sb = document.getElementById('score-body');
    const sorted = [state.players[0], state.players[3], state.players[1], state.players[2]];
    sb.innerHTML = sorted.map(p => {
        let jackIcons = p.jacks.map(j => `<span class="j-mini">J${j}</span>`).join('');
        return `<tr><td style="text-align:left; padding-left:5px;">${p.name}${jackIcons}</td><td>${p.hScore}</td><td>${p.total}</td></tr>`;
    }).join('');
    const handDiv = document.getElementById('player-hand'); handDiv.innerHTML = '';
    state.players[0].hand.forEach((c, i) => {
        const div = document.createElement('div');
        div.className = `card ${c.s==='♥'||c.s==='♦'?'red':''} ${state.phase==='PLAYING'&&state.turn===0&&isLegal(c)?'legal':''} ${state.selected.includes(i)?'selected':''}`;
        div.innerHTML = `<span>${c.v}</span><span>${c.s}</span>`;
        div.onclick = () => handleCardClick(i); handDiv.appendChild(div);
    });
    document.getElementById('status-bar').innerText = state.phase === 'PASSING' ? 'PASS 3 CARDS TO WEST' : '';
    for(let i=0; i<4; i++) {
        const isActive = (state.phase==='PLAYING' && state.turn===i);
        document.getElementById(`tag-${i}`).className = `plr-tag ${isActive ? 'active-tag' : ''}`;
    }
}

function handleCardClick(idx) {
    if (state.phase === 'PASSING') {
        if (state.selected.includes(idx)) state.selected = state.selected.filter(i => i !== idx);
        else if (state.selected.length < 3) state.selected.push(idx);
        const btnCont = document.getElementById('btn-container');
        if (state.selected.length === 3) btnCont.innerHTML = `<button class="btn" style="background:#00ff00;" onclick="executePass()">PASS 3</button>`;
        else btnCont.innerHTML = `<span style="font-size:0.8rem; color:white;">Select ${3-state.selected.length}</span>`;
    } else if (state.phase === 'PLAYING' && state.turn === 0) {
        if (isLegal(state.players[0].hand[idx])) playCard(0, idx);
    }
    updateUI();
}

function executePass() {
    let pCards = state.players.map((plr, i) => {
        if (i === 0) return state.selected.sort((a,b)=>b-a).map(idx=>plr.hand.splice(idx,1)[0]);
        let counts = {}; SUITS.forEach(s => counts[s] = plr.hand.filter(c => c.s === s).length);
        let sortedSuits = Object.keys(counts).sort((a,b) => counts[a] - counts[b]);
        let toPass = [];
        for(let s of sortedSuits) {
            let sCards = plr.hand.filter(c => c.s === s).sort((a,b) => b.r - a.r);
            while(sCards.length > 0 && toPass.length < 3) { let c = sCards.shift(); toPass.push(plr.hand.splice(plr.hand.indexOf(c), 1)[0]); }
        }
        return toPass;
    });
    state.players[3].hand.push(...pCards[0]); state.players[1].hand.push(...pCards[3]); state.players[2].hand.push(...pCards[1]); state.players[0].hand.push(...pCards[2]);
    state.players.forEach(sortHand); state.phase = 'PLAYING'; state.selected = []; document.getElementById('btn-container').innerHTML = '';
    let leadS = (state.trump==='NT'?'♣':state.trump);
    state.turn = state.players.findIndex(plr => plr.hand.some(c => c.v === '2' && c.s === leadS));
    updateUI(); if (state.turn !== 0) setTimeout(aiPlay, 800);
}

function isLegal(c) {
    if (state.tricksPlayed === 0 && state.trick.length === 0) return c.v === '2' && c.s === (state.trump==='NT'?'♣':state.trump);
    if (state.trick.length === 0) return true;
    let leadS = state.trick[0].card.s;
    return state.players[state.turn].hand.some(x => x.s === leadS) ? c.s === leadS : true;
}

function playCard(pI, cI) {
    let isLead = (state.trick.length === 0);
    let card = state.players[pI].hand.splice(cI, 1)[0]; 
    state.trick.push({player: pI, card: card});
    document.getElementById(`slot-${pI}`).innerHTML = `<div class="card ${card.s==='♥'||card.s==='♦'?'red':''} ${isLead ? 'lead-highlight' : ''}"><span>${c.v}</span><span>${c.s}</span></div>`;
    if (state.trick.length < 4) { state.turn = CW_ORDER[(CW_ORDER.indexOf(pI) + 1) % 4]; updateUI(); if (state.turn !== 0) setTimeout(aiPlay, 700); } 
    else { state.turn = null; setTimeout(resolveTrick, 1500); }
}

function aiPlay() {
    let p = state.players[state.turn], legal = p.hand.filter(c => isLegal(c));
    legal.sort((a,b) => a.r - b.r);
    let chosen = (state.tricksPlayed === 0 || state.tricksPlayed === 12 || state.trick.some(t=>t.card.v==='J')) ? legal[0] : legal[legal.length-1];
    playCard(state.turn, p.hand.indexOf(chosen));
}

function cardBeat(n, o) {
    let l = state.trick[0].card.s;
    if (n.s === state.trump && o.s !== state.trump) return true;
    if (o.s === state.trump && n.s !== state.trump) return false;
    return n.s === l && (o.s !== l || n.r > o.r);
}

function resolveTrick() {
    let winObj = state.trick.reduce((a,b) => cardBeat(b.card, a.card) ? b : a);
    let jacks = state.trick.filter(t => t.card.v === 'J');
    let pts = 0;
    
    // Logic: +2 for clean middle tricks, -1 for penalty tricks, Jacks eat the +2 and add -1
    if (state.tricksPlayed === 0 || state.tricksPlayed === 12) {
        pts = -1;
    } else if (jacks.length > 0) {
        pts = (jacks.length * -1); // Jack eats the 2 points and gives -1
    } else {
        pts = 2; // Clean middle tricks now worth +2
    }
    jacks.forEach(j => state.players[winObj.player].jacks.push(j.card.s));
    state.players[winObj.player].hScore += pts;
    state.tricksPlayed++; state.turn = winObj.player; state.trick = [];
    for(let i=0; i<4; i++) document.getElementById(`slot-${i}`).innerHTML = '';
    if (state.tricksPlayed === 13) setTimeout(endRound, 500); else { updateUI(); if (state.turn !== 0) setTimeout(aiPlay, 800); }
}

function endRound() {
    state.players.forEach(p => { if (p.hScore > 0) p.total += p.hScore; });
    let winners = state.players.filter(p => p.total >= 10);
    if (winners.length > 0) {
        state.winner = winners.sort((a,b) => b.total - a.total)[0];
        showWinScreen();
    } else {
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('modal-content').innerHTML = `<h3>ROUND RESULTS</h3>` + state.players.map(p => `<p>${p.name}: ${p.hScore} pts</p>`).join('') + `<button class="btn" style="width:100%" onclick="nextHand()">CONTINUE</button>`;
    }
}

function showWinScreen() {
    document.getElementById('overlay').style.display = 'none';
    const screen = document.getElementById('win-screen');
    document.getElementById('winner-name').innerText = state.winner.name + " WON!";
    screen.style.display = 'flex';
}
function nextHand() { document.getElementById('overlay').style.display = 'none'; state.handIdx++; startRound(); }
</script>
</body>
</html>
