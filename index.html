<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Davis Knaves - Pro Edition</title>
    <style>
        :root { --gold: #ffd700; --bg: #050505; --card-w: 48px; --card-h: 70px; --lead-green: #00ff00; }
        body { background: var(--bg); color: white; font-family: -apple-system, sans-serif; margin: 0; overflow: hidden; position: fixed; width: 100%; height: 100dvh; }
        #game-layout { display: flex; flex-direction: column; height: 100dvh; background: radial-gradient(circle, #1b4d21 0%, #0a200b 100%); padding-bottom: env(safe-area-inset-bottom); box-sizing: border-box; justify-content: space-between; }
        #watermark { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); font-size: 2.2rem; color: rgba(255,215,0,0.08); font-weight: 900; pointer-events: none; z-index: 1; letter-spacing: 4px; }
        #hud { position: relative; padding: 10px; display: flex; justify-content: space-between; z-index: 100; align-items: flex-start; }
        #score-panel { background: rgba(0,0,0,0.85); padding: 5px; border-radius: 4px; border: 1px solid #444; width: 70%; }
        #score-table { font-size: 0.7rem; border-collapse: collapse; text-align: center; width: 100%; }
        #score-table th { color: var(--gold); border-bottom: 1px solid #555; }
        .j-mini { font-size: 0.65rem; margin-left: 2px; color: var(--gold); font-weight: bold; background: rgba(255,215,0,0.2); padding: 0 2px; border-radius: 2px; }
        #trump-box { background: white; color: black; padding: 8px; border-radius: 6px; border: 3px solid var(--gold); text-align: center; font-weight: bold; font-size: 1rem; min-width: 70px; }
        #arena { flex: 1; display: grid; grid-template-areas: ". north ." "west table east" ". south ."; grid-template-columns: 1fr 1.2fr 1fr; grid-template-rows: 1fr 1.4fr 1fr; position: relative; }
        .plr-tag { font-size: 0.75rem; background: #222; padding: 4px 10px; border-radius: 6px; }
        .active-tag { background: #00ff00 !important; color: #000 !important; font-weight: bold; box-shadow: 0 0 12px #00ff00; }
        .slot { width: var(--card-w); height: var(--card-h); border: 1px dashed rgba(255,255,255,0.15); border-radius: 6px; margin: auto; display: flex; align-items: center; justify-content: center; }
        .card { width: var(--card-w); height: var(--card-h); background: white; color: black; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; border: 1px solid #999; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        .card.red { color: #d32f2f; }
        .card.legal { border: 2.5px solid #00ff00; transform: translateY(-4px); }
        .card.selected { border: 3px solid var(--gold); transform: translateY(-15px); background: #fffbe6; }
        .lead-highlight { border: 3px solid var(--lead-green) !important; box-shadow: 0 0 15px var(--lead-green); }
        #player-zone { display: flex; flex-direction: column; align-items: center; width: 100%; padding-bottom: 10px; }
        #player-hand { display: flex; gap: 3px; justify-content: center; width: 100%; padding: 0 10px; box-sizing: border-box; }
        .btn { padding: 12px 24px; background: var(--gold); border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; cursor: pointer; color: black; box-shadow: 0 4px 0 #b8860b; }
        .btn-undo { background: #ff4444 !important; box-shadow: 0 4px 0 #990000 !important; color: white !important; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 5000; }
        .modal { background: white; color: black; padding: 25px; border-radius: 15px; width: 85%; max-width: 380px; text-align: center; }
        #win-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9000; text-align: center; overflow: hidden; }
        .confetti { position: absolute; width: 10px; height: 10px; z-index: 9001; animation: fall linear forwards; top: -10px; }
        @keyframes fall { to { transform: translateY(110dvh) rotate(720deg); } }
        #hof-btn { position: absolute; bottom: 10px; left: 10px; font-size: 0.7rem; background: rgba(255,255,255,0.1); color: white; border: 1px solid #444; padding: 5px; border-radius: 4px; }
        .recap-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.95rem; }
        .recap-table th { background: #f0f0f0; padding: 8px; border: 1px solid #ddd; }
        .recap-table td { padding: 8px; border: 1px solid #ddd; }
    </style>
</head>
<body>
<div id="game-layout">
    <div id="watermark">DAVIS KNAVES</div>
    <div id="hud">
        <div id="score-panel">
            <table id="score-table">
                <thead><tr><th>PLAYER</th><th>RND</th><th>TOT</th></tr></thead>
                <tbody id="score-body"></tbody>
            </table>
        </div>
        <div id="trump-box">TRUMP<br><span id="trump-suit">‚ô£</span></div>
    </div>
    <div style="height:30px; text-align:center; font-weight:bold; color:var(--gold);" id="status-bar"></div>
    <div id="arena">
        <div style="grid-area: north; text-align: center;"><div id="tag-1" class="plr-tag">NORTH</div><div id="slot-1" class="slot"></div></div>
        <div style="grid-area: west; text-align: center;"><div id="tag-3" class="plr-tag">WEST</div><div id="slot-3" class="slot"></div></div>
        <div style="grid-area: south; text-align: center;"><div id="tag-0" class="plr-tag">YOU</div><div id="slot-0" class="slot"></div></div>
        <div style="grid-area: east; text-align: center;"><div id="tag-2" class="plr-tag">EAST</div><div id="slot-2" class="slot"></div></div>
    </div>
    <div id="player-zone">
        <div id="btn-container" style="margin-bottom:10px; height:40px; display:flex; align-items:center; gap:10px;"></div>
        <div id="player-hand"></div>
    </div>
    <button id="hof-btn" onclick="showHOF()">üèÜ HALL OF FAME</button>
</div>

<div id="overlay"><div class="modal" id="modal-content">
    <h2 style="margin:0; color:#1b4d21;">DAVIS KNAVES</h2>
    <div style="text-align: left; padding: 15px 0; font-size: 0.9rem; line-height: 1.6;">
        ‚úÖ Clean Mid-Tricks: <b>+2 pts</b><br>
        ‚ùå Trick 1 & 13: <b>-1 pt</b><br>
        ‚ùå Each Jack Caught: <b>-1 pt</b><br>
        üü¢ <b>Lead Suit:</b> Outlined in Green
    </div>
    <button class="btn" style="width:100%" onclick="startGame()">START GAME</button>
</div></div>

<div id="win-screen">
    <h1 style="color:var(--gold); font-size:3.5rem; margin:0;">WINNER!</h1>
    <h2 id="winner-name" style="margin:10px 0; color:white; font-size: 2.5rem;">PLAYER</h2>
    <p id="winner-stats" style="font-size:1.5rem; color:var(--gold);"></p>
    <button class="btn" onclick="location.reload()" style="margin-top:20px; z-index: 9999;">NEW GAME</button>
</div>

<script>
const SUITS = ['‚ô£','‚ô¶','‚ô†','‚ô•'], VALS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'], ROTATION = ['‚ô£','‚ô¶','‚ô•','‚ô†','NT'], CW_ORDER = [0, 3, 1, 2];
let state = { players: [], handIdx: 0, trump: '‚ô£', turn: null, trick: [], tricksPlayed: 0, selected: [], phase: 'IDLE', undoTimer: null };

function clearCache() { if(confirm("Wipe all data and history?")) { localStorage.clear(); location.reload(); } }

function showHOF() {
    const wins = JSON.parse(localStorage.getItem('knaveWins') || '{"YOU":0,"NORTH":0,"EAST":0,"WEST":0}');
    document.getElementById('overlay').style.display = 'flex';
    document.getElementById('modal-content').innerHTML = `<h3>üèÜ HALL OF FAME</h3>` + 
        Object.entries(wins).map(([k,v]) => `<p>${k}: ${v} Wins</p>`).join('') + 
        `<button class="btn" style="width:100%; margin-top:10px;" onclick="location.reload()">BACK</button>` +
        `<button class="btn" style="width:100%; margin-top:10px; background:#444; color:white;" onclick="clearCache()">CLEAR CACHE</button>`;
}

function recordWin(name) {
    let wins = JSON.parse(localStorage.getItem('knaveWins') || '{"YOU":0,"NORTH":0,"EAST":0,"WEST":0}');
    wins[name] = (wins[name] || 0) + 1;
    localStorage.setItem('knaveWins', JSON.stringify(wins));
}

function startGame() { init(); document.getElementById('overlay').style.display = 'none'; }
function init() { state.players = Array.from({length: 4}, (_, i) => ({ id: i, name: i === 0 ? "YOU" : ["NORTH", "EAST", "WEST"][i-1], hand: [], hScore: 0, total: 0, jacks: [] })); startRound(); }

function startRound() {
    state.phase = 'PASSING'; state.trump = ROTATION[state.handIdx % 5]; state.tricksPlayed = 0; state.trick = []; state.selected = [];
    state.players.forEach(p => { p.jacks = []; p.hScore = 0; p.hand = []; });
    let deck = []; SUITS.forEach(s => VALS.forEach(v => deck.push({s, v, r: VALS.indexOf(v)}))); deck.sort(() => Math.random() - 0.5);
    state.players.forEach(p => { p.hand = deck.splice(0, 13); sortHand(p); });
    const ts = document.getElementById('trump-suit'); ts.innerText = state.trump;
    ts.style.color = (state.trump==='‚ô•'||state.trump==='‚ô¶') ? 'red' : 'black';
    updateUI();
}

function sortHand(p) { p.hand.sort((a,b) => a.s !== b.s ? SUITS.indexOf(a.s)-SUITS.indexOf(b.s) : a.r-b.r); }

function updateUI() {
    const sb = document.getElementById('score-body');
    const sorted = [state.players[0], state.players[3], state.players[1], state.players[2]];
    sb.innerHTML = sorted.map(p => {
        let jacks = p.jacks.map(j => `<span class="j-mini">J${j}</span>`).join('');
        return `<tr><td style="text-align:left; padding-left:5px;">${p.name}${jacks}</td><td>${p.hScore}</td><td>${p.total}</td></tr>`;
    }).join('');
    const handDiv = document.getElementById('player-hand'); handDiv.innerHTML = '';
    state.players[0].hand.forEach((c, i) => {
        const div = document.createElement('div');
        div.className = `card ${c.s==='‚ô•'||c.s==='‚ô¶'?'red':''} ${state.phase==='PLAYING'&&state.turn===0&&isLegal(c)?'legal':''} ${state.selected.includes(i)?'selected':''}`;
        div.innerHTML = `<span>${c.v}</span><span>${c.s}</span>`;
        div.onclick = () => handleCardClick(i); handDiv.appendChild(div);
    });
    for(let i=0; i<4; i++) {
        document.getElementById(`tag-${i}`).className = `plr-tag ${state.turn===i ? 'active-tag' : ''}`;
    }
}

function handleCardClick(idx) {
    if (state.phase === 'PASSING') {
        if (state.selected.includes(idx)) state.selected = state.selected.filter(i => i !== idx);
        else if (state.selected.length < 3) state.selected.push(idx);
        const btnCont = document.getElementById('btn-container');
        btnCont.innerHTML = state.selected.length === 3 ? `<button class="btn" style="background:#00ff00;" onclick="executePass()">PASS 3</button>` : `<span style="color:white">Select 3</span>`;
    } else if (state.phase === 'PLAYING' && state.turn === 0 && !state.undoTimer) {
        if (isLegal(state.players[0].hand[idx])) playCard(0, idx);
    }
    updateUI();
}

function executePass() {
    let pCards = state.players.map((plr, i) => i === 0 ? state.selected.sort((a,b)=>b-a).map(idx=>plr.hand.splice(idx,1)[0]) : plr.hand.splice(0,3));
    state.players[3].hand.push(...pCards[0]); state.players[1].hand.push(...pCards[3]); state.players[2].hand.push(...pCards[1]); state.players[0].hand.push(...pCards[2]);
    state.players.forEach(sortHand); state.phase = 'PLAYING'; state.selected = []; document.getElementById('btn-container').innerHTML = '';
    let leadS = (state.trump==='NT'?'‚ô£':state.trump);
    state.turn = state.players.findIndex(plr => plr.hand.some(c => c.v === '2' && c.s === leadS));
    updateUI(); if (state.turn !== 0) setTimeout(aiPlay, 800);
}

function isLegal(c) {
    if (state.tricksPlayed === 0 && state.trick.length === 0) return c.v === '2' && c.s === (state.trump==='NT'?'‚ô£':state.trump);
    if (state.trick.length === 0) return true;
    let leadS = state.trick[0].card.s;
    return state.players[state.turn].hand.some(x => x.s === leadS) ? c.s === leadS : true;
}

function playCard(pI, cI) {
    let card = state.players[pI].hand.splice(cI, 1)[0];
    state.trick.push({player: pI, card: card, originalIdx: cI});
    document.getElementById(`slot-${pI}`).innerHTML = `<div class="card ${card.s==='‚ô•'||card.s==='‚ô¶'?'red':''} ${state.trick.length===1?'lead-highlight':''}"><span>${card.v}</span><span>${card.s}</span></div>`;
    
    if (state.trick.length < 4) {
        state.turn = CW_ORDER[(CW_ORDER.indexOf(pI) + 1) % 4];
        updateUI(); if (state.turn !== 0) setTimeout(aiPlay, 700);
    } else {
        state.turn = null; updateUI();
        const btnCont = document.getElementById('btn-container');
        btnCont.innerHTML = `<button class="btn btn-undo" onclick="undoTrick()">UNDO TRICK (2s)</button>`;
        state.undoTimer = setTimeout(() => {
            btnCont.innerHTML = ''; state.undoTimer = null;
            resolveTrick();
        }, 2000);
    }
}

function undoTrick() {
    clearTimeout(state.undoTimer); state.undoTimer = null;
    document.getElementById('btn-container').innerHTML = '';
    while(state.trick.length > 0) {
        let move = state.trick.pop();
        state.players[move.player].hand.splice(move.originalIdx, 0, move.card);
        document.getElementById(`slot-${move.player}`).innerHTML = '';
    }
    state.turn = 0; updateUI();
}

function aiPlay() {
    if(state.turn === null) return;
    let p = state.players[state.turn], legal = p.hand.filter(c => isLegal(c));
    playCard(state.turn, p.hand.indexOf(legal[0]));
}

function cardBeat(n, o) {
    let l = state.trick[0].card.s;
    if (n.s === state.trump && o.s !== state.trump) return true;
    if (o.s === state.trump && n.s !== state.trump) return false;
    return n.s === l && (o.s !== l || n.r > o.r);
}

function resolveTrick() {
    let winObj = state.trick.reduce((a,b) => cardBeat(b.card, a.card) ? b : a);
    let jacks = state.trick.filter(t => t.card.v === 'J');
    let pts = (state.tricksPlayed === 0 || state.tricksPlayed === 12) ? -1 : (jacks.length > 0 ? jacks.length * -1 : 2);
    jacks.forEach(j => state.players[winObj.player].jacks.push(j.card.s));
    state.players[winObj.player].hScore += pts;
    state.tricksPlayed++; state.turn = winObj.player; state.trick = [];
    for(let i=0; i<4; i++) document.getElementById(`slot-${i}`).innerHTML = '';
    if (state.tricksPlayed === 13) setTimeout(endRound, 500); 
    else { updateUI(); if (state.turn !== 0) setTimeout(aiPlay, 800); }
}

function endRound() {
    state.players.forEach(p => { if (p.hScore > 0) p.total += p.hScore; });
    let winners = state.players.filter(p => p.total >= 10);
    document.getElementById('overlay').style.display = 'flex';
    
    let tableHtml = `<table class="recap-table"><thead><tr><th>PLAYER</th><th>ROUND</th><th>TOTAL</th></tr></thead><tbody>`;
    state.players.forEach(p => {
        tableHtml += `<tr><td>${p.name}</td><td>+${p.hScore}</td><td><b>${p.total}</b></td></tr>`;
    });
    tableHtml += `</tbody></table>`;

    if (winners.length) {
        state.winner = winners.sort((a,b) => b.total - a.total)[0];
        document.getElementById('modal-content').innerHTML = `<h3>FINAL SCOREBOARD</h3>` + tableHtml + `<button class="btn" style="width:100%" onclick="celebrate()">DECLARE WINNER & CELEBRATE</button>`;
    } else {
        document.getElementById('modal-content').innerHTML = `<h3>ROUND RECAP</h3>` + tableHtml + `<button class="btn" style="width:100%" onclick="nextHand()">CONTINUE NEXT ROUND</button>`;
    }
}

function celebrate() {
    recordWin(state.winner.name);
    document.getElementById('overlay').style.display = 'none';
    const s = document.getElementById('win-screen');
    document.getElementById('winner-name').innerText = state.winner.name;
    document.getElementById('winner-stats').innerText = "Final Score: " + state.winner.total;
    s.style.display = 'flex';
    setInterval(spawnConfetti, 150); // Flowing continuously
}

function spawnConfetti() {
    const c = document.createElement('div'); c.className = 'confetti';
    c.style.left = Math.random() * 100 + 'vw';
    c.style.backgroundColor = ['#ff0','#f0f','#0ff','#0f0','#fff','#ffd700'][Math.floor(Math.random()*6)];
    c.style.animationDuration = (Math.random() * 2 + 3) + 's';
    document.getElementById('win-screen').appendChild(c);
    setTimeout(() => c.remove(), 5000); // Clean up for infinite flow
}

function nextHand() { document.getElementById('overlay').style.display = 'none'; state.handIdx++; startRound(); }
</script>
</body>
</html>
